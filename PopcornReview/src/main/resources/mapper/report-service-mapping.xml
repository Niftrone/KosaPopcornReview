<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ns.sql.ReportMapper">

	<resultMap id="ReportedReviewMap" type="com.service.popcornreview.vo.ReportedReview">
		<id property="rrId" column="rr_id"/>
		<result property="rrPlot" column="rr_plot"/>
		<result property="rrDate" column="rr_date"/>

		<association property="user" javaType="com.service.popcornreview.vo.User">
			<id property="id" column="reporter_id"/>
			<result property="name" column="reporter_name"/>
		</association>

		<association property="review" javaType="com.service.popcornreview.vo.Review">
			<id property="rId" column="r_id"/>
			<result property="rPlot" column="r_plot"/>
			<association property="user" javaType="com.service.popcornreview.vo.User">
				<id property="id" column="review_author_id"/>
				<result property="name" column="review_author_name"/>
			</association>
		</association>
	</resultMap>

	<resultMap id="ReportedReviewWithReviewMap" type="com.service.popcornreview.vo.ReportedReview">
		<id property="rrId" column="rr_id"/>
		<result property="rrPlot" column="rr_plot"/>
		<result property="rrDate" column="rr_date"/>

		<association property="review" javaType="com.service.popcornreview.vo.Review">
			<id property="rId" column="r_id"/>
			<result property="rPlot" column="r_plot"/>
		</association>
	</resultMap>


	<select id="getReported" resultMap="ReportedReviewMap">
		SELECT
			rr.rr_id,
			rr.rr_plot,
			rr.rr_date,
			rev.r_id,
			rev.r_plot,
			reporter.id   AS reporter_id,
			reporter.name AS reporter_name,
			author.id     AS review_author_id,
			author.name   AS review_author_name
		FROM
			REPORTED_REVIEWS rr
		JOIN
			review rev ON rr.r_id = rev.r_id
		JOIN
			user reporter ON rr.user_id = reporter.id
		JOIN
			user author ON rev.user_id = author.id
		ORDER BY
			rr.rr_date DESC
	</select>

	<select id="getReportedReviewById" parameterType="int" resultMap="ReportedReviewWithReviewMap">
		SELECT
			rr.rr_id,
			rr.rr_plot,
			rr.rr_date,
			r.r_id,
			r.r_plot
		FROM
			REPORTED_REVIEWS rr
		JOIN
			review r ON rr.r_id = r.r_id
		WHERE
			rr.rr_id = #{rrId}
	</select>


	<insert id="insertReported" parameterType="com.service.popcornreview.vo.ReportedReview">
		INSERT INTO REPORTED_REVIEWS (rr_plot, rr_date, r_id, user_id)
		VALUES (#{rrPlot}, CURDATE(), #{review.rId}, #{user.id})
	</insert>


	<delete id="deleteReported" parameterType="int">
		DELETE FROM REPORTED_REVIEWS WHERE rr_id = #{rrId}
	</delete>

	<delete id="deleteAllReportsByReviewId" parameterType="int">
		DELETE FROM REPORTED_REVIEWS WHERE r_id = #{rId}
	</delete>

</mapper>
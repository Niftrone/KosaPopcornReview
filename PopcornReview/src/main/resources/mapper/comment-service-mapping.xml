<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ns.sql.CommentMapper">

	<insert id="addComment" parameterType="comment">
		INSERT INTO comment (c_id, c_plot, c_date, review_id, user_id)
		VALUES (#{cId}, #{cPlot}, curdate(), #{review.rId}, #{user.id})
	</insert>
	
	<delete id="deleteComment" parameterType="int">
		DELETE FROM comment
		WHERE c_id = #{cId}
	</delete>
	
	<update id="updateComment" parameterType="comment">
		UPDATE comment
		SET c_plot = #{cPlot}
		WHERE c_id = #{cId}
	</update>
	
	<resultMap type="comment" id="commentListRM">
		<id property="cId" column="c_id"/>
		<result property="cPlot" column="c_plot"/>
		<result property="cDate" column="c_date"/>
        <result property="id" column="comment_user_id"/>
        <result property="rId" column="r_id"/>

		<association property="user" javaType="user">
			<id property="id" column="comment_user_id"/>
			<result property="name" column="comment_user_name"/>
			<result property="email" column="comment_user_email"/>
			</association>
		
		<association property="review" javaType="review">
			<id property="rId" column="r_id"/>
			<result property="rRating" column="r_rating"/>
			<result property="rPlot" column="r_plot"/>
			<result property="rDate" column="r_date"/>
			</association>
	</resultMap>
	
    <select id="getComments" parameterType="int" resultMap="commentListRM">
	    SELECT 
	        c.c_id, c.c_plot, c.c_date, 
	        
            -- 댓글 작성자 정보 (별칭 사용)
	        u.id    AS comment_user_id,
            u.name  AS comment_user_name,
            u.email AS comment_user_email,

            -- 리뷰 정보
	        r.r_id, r.r_rating, r.r_plot, r.r_date,
	        r.m_id
	    FROM comment c
	    JOIN user u ON c.user_id = u.id
	    JOIN review r ON c.review_id = r.r_id
	    <where>
	        <choose>
		        	<when test="review != null and review.rId != null">
		        		c.review_id = #{review.rId}
		        	</when>
		        	<when test="user != null and user.id != null">
		        		c.user_id = #{user.id}
		        	</when>
	        </choose>
	    </where>
	    ORDER BY c.c_date DESC
    </select>
    <!-- user가 삭제될때 comment도 같이 삭제 -->
    <delete id="deleteCommentsByUserId" parameterType="string">
    DELETE FROM comment WHERE user_id = #{userId}
</delete>
</mapper>